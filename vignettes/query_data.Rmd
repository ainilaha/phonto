---
title: "Query Data"
date: "Updated on : `r date()`"
output: html_document
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Setup 
Install the package for the first time.
`devtools::install_github("ccb-hms/phonto")`

```{r setup,warning=FALSE,message=FALSE}
library(phonto)
library(DT)
library(nhanesA)
```

# Query Data 

## Step 1: search tables

It can be search by certain variable.

Notes: the name of the functions are not really meaningful from nhanesA.

```{r search_tables,warning=FALSE,message=FALSE}
tb_names <- nhanesSearchVarName('BPXPULS')
tb_names
```
It can be search by partial of the table names
```{r search_tables1,warning=FALSE,message=FALSE}
tb_names <- nhanesSearchTableNames('BPX')
tb_names
```
More search methods can found on [nhanesA doc](https://cran.r-project.org/web/packages/nhanesA/vignettes/Introducing_nhanesA.html)

## Step 2: check tables

#### 1) A quick way to do it is to show the table names' details, and we can find the table named "P_BPXO" and "BPXO_J" are different from the rest of the tables that present blood pressures.
```{r check_tables,warning=FALSE,message=FALSE}
tb_detail <- nhanesSearchTableNames('BPX', includerdc=TRUE, nchar=42, details=TRUE)
datatable(tb_detail)
```
#### 2) We can also check tables by showing the variables and descriptions in the tables.
For example,
```{r check_tables2,warning=FALSE,message=FALSE}
var_detail <- variableDescr("BPX_D")
datatable(var_detail)
```


## Step 3: check tables

### 1) Given the information from the above two steps, we can query data by specifying tables and columns.

```{r query,warning=FALSE,message=FALSE}
tables <- c("BPX_D","BPX_E","BPX","BPX_C")
cols <- c("BPXDI1","BPXDI2","BPXSY1","BPXSY2")
bpx_data <- queryData(tables,cols)
datatable(bpx_data)

```


### Check the data availability over the years
In the following matrix, 0 means the tables have no data in that year, and 1 means they have data in corresponding years.

```{r years,warning=FALSE,message=FALSE}

mtx <- check_data()
DT::datatable(
  mtx
) |> DT::formatStyle(colnames(mtx),
                 backgroundColor = styleInterval(c(0, 1), c('gray', 'red',"white")),
                 fontWeight = 'bold')

```



```{r PHSEANT,warning=FALSE,message=FALSE}
# df1$RIDRETH1 <- as.factor(df1$RIDRETH1)
# phs_data <- phesant(df1)
# phs_res <- phseant_table(phs_data$phs_types,"./search.json")
# library(kableExtra)
# phs_res |> kbl() |> kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

```

